<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aave vs Banks â€” split data files</title>
  <style>
    :root{
      --bg:#9C8CF4;
      --card:rgba(255,255,255,.06);
      --card-2:rgba(255,255,255,.08);
      --highlight:rgba(255,255,255,.22);
      --text:#ffffff;
      --ink:#0b061d;
      --up:#31d158;
      --down:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family: Arial, sans-serif; background: var(--bg); color: var(--text); }
    .container{ max-width:1000px; margin:0 auto; padding:48px 20px 24px; }
    header h1{ font-size: clamp(32px, 5vw, 64px); margin:0 0 10px; }
    header p{ margin:0 0 18px; opacity:.95; font-size: clamp(14px, 1.6vw, 18px); }

    .actions{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin:10px 0 28px; }
    .group{ background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.28); border-radius:16px; padding:10px; }
    .group h3{ margin:0 0 8px; font-size:14px; opacity:.9; text-transform:uppercase; letter-spacing:.06em; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{ background:#fff; color:var(--ink); border:none; border-radius:999px; padding:9px 12px; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.15); text-decoration:none; display:inline-flex; align-items:center; gap:6px; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .pill{ padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.28); font-size:12px; }
    .muted{ opacity:.85; }

    table{ width:100%; border-collapse:separate; border-spacing:0; background: var(--card); border-radius:18px; overflow:hidden; }
    th, td{ padding:18px 20px; text-align:left; vertical-align:middle; }
    th{ font-size:14px; letter-spacing:.06em; text-transform:uppercase; opacity:.85; border-bottom:1px solid rgba(255,255,255,.16); }
    tr:nth-child(even){ background: var(--card-2); }

    .highlight{ position:relative; background: var(--highlight) !important; font-weight:700; }
    .highlight::before{ content:""; position:absolute; inset:0 auto 0 0; width:6px; background: linear-gradient(180deg, #fff, rgba(255,255,255,.5)); }
    .aave-row.highlight::before{ display:none; }

    .rank-change{
      font-weight:800; font-size:14px;
      padding:4px 8px; border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      margin-left:8px;
      display:inline-flex; align-items:center; gap:6px;
    }
    .up{ color: var(--up); }
    .down{ color: var(--down); }

    .aave-row .aave-wrap{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .aave-row .logo { width:72px; height:72px; display:inline-block; }
    .aave-row .deposit{
      background:#fff; color:var(--ink); text-decoration:none;
      border-radius:999px; padding:8px 12px; font-weight:800;
      box-shadow:0 6px 18px rgba(0,0,0,.15);
    }

    .loading { text-align: center; padding: 40px; opacity: 0.7; }
    .error { color: #ff6b6b; text-align: center; padding: 20px; font-size: 14px; }
    .last-updated { text-align: center; margin-top: 20px; font-size: 12px; opacity: 0.8; }
    .tagline{ margin-top:20px; font-weight:700; letter-spacing:.02em; text-align: center; }

    @media (max-width: 720px){
      thead{ display:none; }
      table, tbody, tr, td{ display:block; width:100%; }
      tr{ padding:12px 14px; }
      td{ padding:8px 6px 8px 120px; position:relative; border-bottom:1px dashed rgba(255,255,255,.18); }
      td::before{ content: attr(data-label); position:absolute; left:14px; top:8px; font-weight:700; opacity:.9; }
      .highlight::before{ width:4px; }
      .aave-row .aave-wrap{ align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Aave vs Banks</h1>
      <p>Built in a rush with love by Hoobi</p>

      <div class="actions">
        <div class="group" id="bankControls">
          <h3>Bank data file (banks.json)</h3>
          <div class="row">
            <button id="refreshBanks" class="btn">ðŸ”„ Refresh Bank Data</button>
            <button id="exportBanks" class="btn">ðŸ’¾ Export Banks</button>
          </div>
          <div class="row" style="margin-top:8px">
            <span class="pill muted" id="banksBadge">No banks cache yet</span>
          </div>
        </div>

        <div class="group" id="aaveControls">
          <h3>Aave historical file (aave.json)</h3>
          <div class="row">
            <button id="refreshAave" class="btn">ðŸ”„ Refresh Aave Data</button>
            <button id="exportAave" class="btn">ðŸ’¾ Export Aave</button>
          </div>
          <div class="row" style="margin-top:8px">
            <span class="pill muted" id="aaveBadge">No aave cache yet</span>
          </div>
        </div>
      </div>
    </header>

    <div class="table-container">
      <div id="loading" class="loading" role="status" aria-live="polite">Loadingâ€¦</div>
      <table id="dataTable" style="display:none;" aria-label="Aave vs Banks ranking">
        <thead>
          <tr>
            <th scope="col">Rank</th>
            <th scope="col">Name</th>
            <th scope="col">Assets</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="msg" class="error" style="display:none;"></div>
    </div>

    <div id="lastUpdated" class="last-updated" aria-live="polite"></div>
    <p class="tagline">DeFi will win, Ethereum will win!</p>
  </div>

  <script>
    // ---------------- Consts & state ----------------
    const BANKS_KEY = 'banksCacheV1';
    const AAVE_KEY  = 'aaveHistCacheV1'; // stores full history array
    const AAVE_FALLBACK_B = 12.5;

    // Minimal fallback banks
    const bankFallback = [
      { name: "JPMORGAN CHASE BK NA", assets: 3643.099 },
      { name: "BANK OF AMER NA", assets: 2615.296 },
      { name: "CITIBANK NA", assets: 1760.921 },
      { name: "WELLS FARGO BK NA", assets: 1711.028 },
      { name: "U S BK NA", assets: 659.191 },
      { name: "GOLDMAN SACHS BK USA", assets: 598.460 },
      { name: "PNC BK NA", assets: 549.324 },
      { name: "TRUIST BK", assets: 527.488 },
      { name: "CAPITAL ONE NA", assets: 490.573 },
      { name: "STATE STREET B&TC", assets: 368.219 },
      { name: "TD BK NA", assets: 366.507 },
      { name: "BANK OF NY MELLON", assets: 356.262 },
      { name: "BMO BK NA", assets: 257.049 },
      { name: "MORGAN STANLEY BK NA", assets: 234.481 },
      { name: "FIRST-CITIZENS B&TC", assets: 228.632 },
      { name: "CITIZENS BK NA", assets: 220.014 },
      { name: "FIFTH THIRD BK NA", assets: 211.921 },
      { name: "MANUFACTURERS & TRADERS TC", assets: 209.801 },
      { name: "HUNTINGTON NB", assets: 208.159 },
      { name: "AMERICAN EXPRESS NB", assets: 203.448 }
    ];

    // ---------------- Utils ----------------
    const $ = sel => document.querySelector(sel);
    const formatB = v => `$${v.toFixed(1)} B`;
    const nowISO = () => new Date().toISOString();

    const readCache = key => { try { return JSON.parse(localStorage.getItem(key) || 'null'); } catch { return null; } };
    const writeCache = (key, obj) => localStorage.setItem(key, JSON.stringify(obj));

    const setBadge = (id, dateOrNull, labelWhenEmpty) => {
      const el = $(id);
      if (!dateOrNull) { el.textContent = labelWhenEmpty; return; }
      el.textContent = `Cached: ${new Date(dateOrNull).toLocaleString()}`;
    };

    function downloadJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    async function fetchJSON(url){
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return res.json();
    }

    // ---------------- Fetchers ----------------
    // Banks: scrape Fed page
    async function fetchBanks(){
      try{
        const proxy = 'https://api.allorigins.win/get?url=';
        const url = encodeURIComponent('https://www.federalreserve.gov/releases/lbr/current/');
        const resp = await fetch(`${proxy}${url}`, { cache:'no-store' });
        if(!resp.ok) throw new Error('banks fetch failed');
        const { contents } = await resp.json();
        const doc = new DOMParser().parseFromString(contents, 'text/html');
        const rows = doc.querySelectorAll('tr');
        const out = [];
        for (const row of rows){
          const tds = row.querySelectorAll('td');
          if (tds.length >= 6){
            const name = tds[0]?.textContent?.trim() || '';
            const assets = tds[5]?.textContent?.trim() || '';
            if ((name.includes('BK') || name.includes('BANK')) && assets){
              const n = parseFloat(assets.replace(/[^0-9.]/g,''));
              if (!isNaN(n) && n>100){
                out.push({ name: name.split('/')[0].trim(), assets: n/1000 });
              }
            }
          }
        }
        return out.sort((a,b)=>b.assets-a.assets).slice(0,50);
      }catch(e){
        console.warn('banks fallback', e);
        return bankFallback;
      }
    }

    // Aave historical from /protocol/{protocol}
    function coerceAavePoint(x){
      if (typeof x === 'number') return x;
      if (x && typeof x === 'object'){
        const v = x.totalLiquidityUSD ?? x.totalLiquidityUsd ?? x.totalLiquidity ?? x.value ?? x.tvl;
        if (typeof v === 'number') return v;
      }
      return null;
    }
    async function fetchAaveHistory(){
      // Docs endpoint: https://api.llama.fi/protocol/aave
      const data = await fetchJSON('https://api.llama.fi/protocol/aave');
      const arr = Array.isArray(data.tvl) ? data.tvl : [];
      return arr;
    }

    // ---------------- Rendering (today-only) ----------------
    function renderToday(banks, aaveHist){
      const table = $('#tableBody');
      table.innerHTML = '';

      // get "today" Aave = last value in history
      let aaveUsd = null;
      if (Array.isArray(aaveHist) && aaveHist.length){
        const last = aaveHist[aaveHist.length - 1];
        const v = coerceAavePoint(last);
        if (typeof v === 'number' && isFinite(v)) aaveUsd = v;
      }
      const aaveB = (aaveUsd ?? AAVE_FALLBACK_B * 1e9) / 1e9; // billions

      const combined = [...banks, { name:'Aave', assets: aaveB, isAave:true }];
      const sorted = combined.sort((a,b)=>b.assets-a.assets);
      const idx = sorted.findIndex(x=>x.isAave);

      const start = Math.max(0, idx - 4);
      const end   = Math.min(sorted.length - 1, idx + 5);
      const slice = sorted.slice(start, end+1);

      for (let i=0;i<slice.length;i++){
        const item = slice[i];
        const rank = start + i + 1;
        const isAave = !!item.isAave;

        const tr = document.createElement('tr');
        if (isAave) tr.className = 'aave-row highlight';

        const nameCell = isAave
          ? `<div class="aave-wrap">
               <span class="logo"><img src="aave.svg" alt="Aave logo" style="width:150px;height:72px;vertical-align:middle;"></span>
               <a class="deposit" href="https://app.aave.com/" target="_blank" rel="noopener noreferrer">ðŸ’§ Deposit now</a>
             </div>`
          : item.name;

        /* ONLY Aave shows a rank-change badge, constant "^ 3" up */
        const badge = isAave
          ? `<span class="rank-change up" aria-label="rank change up by 3">^ 3</span>`
          : '';

        tr.innerHTML = `
          <td data-label="Rank">${rank}${badge}</td>
          <td data-label="Name">${nameCell}</td>
          <td data-label="Assets">${formatB(item.assets)}</td>
        `;
        table.appendChild(tr);
      }

      // info line
      const msg = $('#msg');
      msg.style.display = 'block';
      msg.style.color = '#fff';
      msg.style.opacity = '.85';
      msg.textContent = `Showing Aave (rank ${idx+1}) vs banks â€¢ Today only`;
    }

    // ---------------- Boot & wiring ----------------
    async function boot(){
      const banksCache = readCache(BANKS_KEY);
      const aaveCache  = readCache(AAVE_KEY);

      setBadge('#banksBadge', banksCache?.updatedAt, 'No banks cache yet');
      setBadge('#aaveBadge',  aaveCache?.updatedAt,  'No aave cache yet');

      const banks = banksCache?.banks || bankFallback;
      const aaveHist = aaveCache?.history || [];

      renderToday(banks, aaveHist);
      $('#loading').style.display = 'none';
      $('#dataTable').style.display = 'table';
      const ts = banksCache?.updatedAt || aaveCache?.updatedAt || nowISO();
      $('#lastUpdated').textContent = `Last updated: ${new Date(ts).toLocaleString()}`;
    }

    // --- Buttons: Refresh ---
    $('#refreshBanks').addEventListener('click', async (e)=>{
      const btn = e.currentTarget; btn.disabled = true; btn.textContent = 'Refreshingâ€¦';
      try{
        const banks = await fetchBanks();
        const stamp = nowISO();
        writeCache(BANKS_KEY, { updatedAt: stamp, banks });
        setBadge('#banksBadge', stamp, 'No banks cache yet');

        const aaveHist = (readCache(AAVE_KEY)||{}).history || [];
        renderToday(banks, aaveHist);
        $('#lastUpdated').textContent = `Last updated: ${new Date(stamp).toLocaleString()} (banks)`;
      }catch(err){ console.error(err); }
      finally{ btn.disabled = false; btn.textContent = 'ðŸ”„ Refresh Bank Data'; }
    });

    $('#refreshAave').addEventListener('click', async (e)=>{
      const btn = e.currentTarget; btn.disabled = true; btn.textContent = 'Refreshingâ€¦';
      try{
        const history = await fetchAaveHistory();
        const stamp = nowISO();
        writeCache(AAVE_KEY, { updatedAt: stamp, history });
        setBadge('#aaveBadge', stamp, 'No aave cache yet');

        const banks = (readCache(BANKS_KEY)||{}).banks || bankFallback;
        renderToday(banks, history);
        $('#lastUpdated').textContent = `Last updated: ${new Date(stamp).toLocaleString()} (aave)`;
      }catch(err){ console.error(err); }
      finally{ btn.disabled = false; btn.textContent = 'ðŸ”„ Refresh Aave Data'; }
    });

    // --- Buttons: Export ---
    $('#exportBanks').addEventListener('click', ()=>{
      const cache = readCache(BANKS_KEY);
      if (!cache){ alert('No banks cache yet. Refresh first.'); return; }
      downloadJSON(cache, 'banks.json');
    });
    $('#exportAave').addEventListener('click', ()=>{
      const cache = readCache(AAVE_KEY);
      if (!cache){ alert('No aave cache yet. Refresh first.'); return; }
      downloadJSON(cache, 'aave.json');
    });

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
