<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aave vs Banks â€” TVL, Borrowed toggle, Rank</title>
  <style>
    :root{
      --bg:#9C8CF4;
      --card:rgba(255,255,255,.10);
      --card-2:rgba(255,255,255,.08);
      --highlight:rgba(255,255,255,.22);
      --text:#ffffff;
      --ink:#0b061d;
      --up:#31d158;
      --line: rgba(255,255,255,1);
      --grid: rgba(255,255,255,.18);
      --tooltipBg: rgba(15, 10, 30, .92);
      --tooltipBorder: rgba(255,255,255,.25);
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: Arial, sans-serif; background: var(--bg); color: var(--text); }
    .container{ max-width:1000px; margin:0 auto; padding:40px 18px 24px; }

    header h1{ font-size: clamp(32px, 5vw, 60px); margin:0 0 6px; }
    header p{ margin:0 0 12px; opacity:.95; font-size: clamp(14px, 1.6vw, 18px); }

    .card{
      background: var(--card);
      border-radius:18px;
      padding:14px 14px 10px;
      border:1px solid rgba(255,255,255,.22);
      box-shadow:0 6px 30px rgba(0,0,0,.18);
    }
    .card h3{ margin:0 0 8px; font-size:13px; letter-spacing:.08em; text-transform:uppercase; opacity:.95; }

    .chart-wrap{ width:100%; position:relative; }
    canvas{ width:100%; height:260px; display:block; }

    .tooltip{
      position:absolute; pointer-events:none;
      background: var(--tooltipBg); color:#fff;
      border:1px solid var(--tooltipBorder); border-radius:10px;
      padding:8px 10px; font-size:12px; box-shadow:0 8px 24px rgba(0,0,0,.25);
      transform: translate(-50%, -110%); white-space:nowrap; display:none; z-index:2;
    }
    .tooltip .muted{ opacity:.8; }

    /* Borrowed toggle (below chart) */
    .toggle-row{
      display:flex; align-items:center; gap:10px;
      margin-top:10px; padding:10px 12px;
      background:var(--card-2); border:1px solid rgba(255,255,255,.22);
      border-radius:12px;
    }
    .switch{
      position:relative; width:44px; height:24px; background:rgba(255,255,255,.25);
      border-radius:999px; cursor:pointer; flex:0 0 auto; border:1px solid rgba(255,255,255,.3);
    }
    .switch::after{
      content:""; position:absolute; top:2px; left:2px; width:20px; height:20px; border-radius:50%;
      background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.25); transition: transform .18s ease;
    }
    .switch.on{ background:#fff; }
    .switch.on::after{ transform: translateX(20px); background: var(--ink); }

    .toggle-label{
      font-size:14px; opacity:.95;
    }
    .toggle-help{
      font-size:12px; opacity:.8;
    }

    /* KPI row */
    .kpis{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin:12px 0 6px; }
    .kpi{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:var(--card); border:1px solid rgba(255,255,255,.22);
      border-radius:16px; padding:14px 16px;
    }
    .kpi .label{ font-size:12px; text-transform:uppercase; letter-spacing:.08em; opacity:.9; }
    .kpi .value{ font-size: clamp(20px, 4vw, 28px); font-weight:900; letter-spacing:.02em; }
    .kpi .sub{ font-size:12px; opacity:.85; }
    .kpi .btn{
      background:#fff; color:var(--ink); border:none; border-radius:999px;
      padding:8px 12px; font-weight:800; cursor:pointer; text-decoration:none;
      box-shadow:0 6px 18px rgba(0,0,0,.15);
    }

    .table-container{ margin-top:10px; }
    table{
      width:100%; border-collapse:separate; border-spacing:0;
      background: var(--card); border-radius:18px; overflow:hidden;
      border:1px solid rgba(255,255,255,.22); box-shadow:0 8px 30px rgba(0,0,0,.18);
    }
    th, td{ padding:14px 18px; text-align:left; vertical-align:middle; }
    th{
      font-size:13px; letter-spacing:.07em; text-transform:uppercase; opacity:.95;
      background: rgba(255,255,255,.10); border-bottom:1px solid rgba(255,255,255,.22);
      position:sticky; top:0; backdrop-filter: blur(6px);
    }
    tr:nth-child(even){ background: var(--card-2); }
    tbody tr:not(:last-child) td{ border-bottom:1px dashed rgba(255,255,255,.18); }

    .highlight{ position:relative; background: var(--highlight) !important; font-weight:700; }
    .highlight::before{ content:""; position:absolute; inset:0 auto 0 0; width:6px; background: linear-gradient(180deg, #fff, rgba(255,255,255,.5)); }
    .aave-row.highlight::before{ display:none; }

    .assets{ font-size: clamp(16px, 2vw, 20px); font-weight: 900; letter-spacing: .02em; }

    .aave-row .aave-wrap{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; position: relative; }
    .aave-row .logo{ width:72px; height:72px; display:inline-block; }
    .aave-row .deposit{
      background:#fff; color:var(--ink); text-decoration:none; border-radius:999px;
      padding:8px 12px; font-weight:800; box-shadow:0 6px 18px rgba(0,0,0,.15);
      margin-left:80px;
    }

    /* Rank movement badge (white pill) */
    .rank-badge{
      display:inline-flex; align-items:center; gap:6px;
      background:#fff; color:var(--ink);
      border-radius:999px; padding:4px 10px; margin-left:8px;
      font-weight:900; font-size:12px; box-shadow:0 6px 18px rgba(0,0,0,.15);
    }
    .rank-badge .arrow{ font-size:14px; line-height:1; color: var(--up); }

    .loading { text-align:center; padding:20px; opacity:.8; }
    .error { color:#fff; text-align:center; padding:10px; font-size:13px; opacity:.9; }
    .last-updated { text-align:center; margin-top:12px; font-size:12px; opacity:.9; }
    .tagline{ margin-top:12px; font-weight:700; letter-spacing:.02em; text-align:center; }

    .actions{
      display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr));
      gap:10px; margin:14px 0 14px;
    }
    .group{ background:var(--card); border:1px solid rgba(255,255,255,.22); border-radius:16px; padding:10px; }
    .group h3{ margin:0 0 8px; font-size:13px; opacity:.95; text-transform:uppercase; letter-spacing:.06em; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{
      background:#fff; color:var(--ink); border:none; border-radius:999px; padding:9px 12px;
      font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.15);
      text-decoration:none; display:inline-flex; align-items:center; gap:6px;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .pill{ padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.28); font-size:12px; }

    @media (max-width: 850px){ .kpis{ grid-template-columns: 1fr; } }
    @media (max-width: 720px){
      thead{ display:none; }
      table, tbody, tr, td{ display:block; width:100%; }
      tr{ padding:10px 12px; }
      td{
        padding:8px 6px 8px 120px; position:relative;
        border-bottom:1px dashed rgba(255,255,255,.18);
      }
      td::before{ content: attr(data-label); position:absolute; left:14px; top:8px; font-weight:700; opacity:.9; }
      .highlight::before{ width:4px; }
      .aave-row .aave-wrap{ align-items:flex-start; }
      canvas{ height:220px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Aave vs Banks</h1>
      <p>Built in a rush with love by Hoobi</p>
    </header>

    <!-- CHART -->
    <div class="card" id="rankCard" style="display:none; margin-top:8px;">
      <h3>Aave rank (from 20 Aug 2020)</h3>
      <div class="chart-wrap" id="chartWrap">
        <canvas id="rankChart" aria-label="Aave daily rank since 2020-08-20" role="img"></canvas>
        <div class="tooltip" id="tooltip"></div>
      </div>

      <!-- Borrowed toggle -->
      <div class="toggle-row" id="borrowedToggleRow" aria-live="polite">
        <div class="switch" id="borrowedSwitch" role="switch" aria-checked="false" tabindex="0"></div>
        <div>
          <div class="toggle-label">Count borrowed assets to TVL?</div>
          <div class="toggle-help">Adds a fixed $27.87B to Aaveâ€™s assets when ranking vs banks (chart & table update instantly).</div>
        </div>
      </div>
    </div>

    <!-- KPI ROW -->
    <div class="kpis" id="kpiRow" style="display:none;">
      <div class="kpi">
        <div>
          <div class="label">Current Rank</div>
          <div class="value" id="kpiRank">#â€”</div>
          <div class="sub" id="kpiRankSub">vs full US bank list</div>
        </div>
        <a href="#tableAnchor" class="btn" aria-label="Go to table">Go to table</a>
      </div>
      <div class="kpi">
        <div>
          <div class="label">Fees (all-time)</div>
          <div class="value">$1.496B</div>
          <div class="sub">Snapshot</div>
        </div>
      </div>
      <div class="kpi">
        <div>
          <div class="label">Borrowed</div>
          <div class="value" id="kpiBorrowed">$27.87B</div>
          <div class="sub">Fixed (for now)</div>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-container" id="tableAnchor">
      <div id="loading" class="loading" role="status" aria-live="polite">Loadingâ€¦</div>
      <table id="dataTable" style="display:none;" aria-label="Aave vs Banks ranking">
        <thead>
          <tr>
            <th scope="col">Rank</th>
            <th scope="col">Name</th>
            <th scope="col">Assets</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="msg" class="error" style="display:none;"></div>
    </div>

    <!-- ACTIONS -->
    <div class="actions">
      <div class="group" id="bankControls">
        <h3>Bank data file (banks.json)</h3>
        <div class="row">
          <button id="refreshBanks" class="btn">ðŸ”„ Refresh Bank Data</button>
          <button id="exportBanks" class="btn">ðŸ’¾ Export Banks</button>
        </div>
        <div class="row" style="margin-top:6px">
          <span class="pill" id="banksBadge">No banks cache yet</span>
        </div>
      </div>

      <div class="group" id="aaveControls">
        <h3>Aave historical file (aave.json)</h3>
        <div class="row">
          <button id="refreshAave" class="btn">ðŸ”„ Refresh Aave Data</button>
          <button id="exportAave" class="btn">ðŸ’¾ Export Aave</button>
        </div>
        <div class="row" style="margin-top:6px">
          <span class="pill" id="aaveBadge">No aave cache yet</span>
        </div>
      </div>
    </div>

    <div id="lastUpdated" class="last-updated" aria-live="polite"></div>
    <p class="tagline">DeFi will win, Ethereum will win!</p>
  </div>

  <script>
    /* ==== Keys / constants ==== */
    const BANKS_KEY = 'banksCacheV11';
    const AAVE_KEY  = 'aaveHistCacheV10';
    const AAVE_FALLBACK_B = 12.5;
    const FIXED_BORROWED_B = 27.87; // <-- hard-coded borrowed in billions
    const CHART_START = new Date('2020-08-20T00:00:00');

    const bankFallback = [
      { name: "JPMORGAN CHASE BK NA", assets: 3643.099 },
      { name: "BANK OF AMER NA", assets: 2615.296 },
      { name: "CITIBANK NA", assets: 1760.921 },
      { name: "WELLS FARGO BK NA", assets: 1711.028 },
      { name: "U S BK NA", assets: 659.191 },
      { name: "GOLDMAN SACHS BK USA", assets: 598.460 },
      { name: "PNC BK NA", assets: 549.324 },
      { name: "TRUIST BK", assets: 527.488 },
      { name: "CAPITAL ONE NA", assets: 490.573 },
      { name: "STATE STREET B&TC", assets: 368.219 }
    ];

    /* ==== Utils ==== */
    const $ = sel => document.querySelector(sel);
    const nowISO = () => new Date().toISOString();
    const formatB = v => `$${v.toFixed(1)} B`;
    const billions = n => (n / 1e9);
    const readCache  = k => { try { return JSON.parse(localStorage.getItem(k) || 'null'); } catch { return null; } };
    const writeCache = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const setBadge = (id, dateOrNull, emptyTxt) => { const el=$(id); el.textContent = dateOrNull ? `Cached: ${new Date(dateOrNull).toLocaleString()}` : emptyTxt; };
    function downloadJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    async function fetchJSON(url){
      const r = await fetch(url, { cache:'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return r.json();
    }

    /* ==== Banks (FULL list via ASCII) ==== */
    async function fetchBanksFull(){
      const asciiURL = 'https://www.federalreserve.gov/releases/lbr/current/lrg_bnk_lst.txt';
      const via = u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`;
      const res = await fetch(via(asciiURL), { cache:'no-store' });
      if (!res.ok) throw new Error(`banks ASCII HTTP ${res.status}`);
      const text = await res.text();

      const lines = text.split(/\r?\n/);
      const out = [];
      for (const raw of lines){
        const line = raw.trim();
        if (!line) continue;
        if (/^[A-Z \/\-]+$/.test(line) && !/\d/.test(line)) continue;

        const cols = line.split(/\s{2,}/);
        if (cols.length < 6) continue;

        const name = cols[0].split('/')[0].trim();
        const assetsMilStr = cols[5].replace(/,/g,'').trim();
        const assetsMil = parseFloat(assetsMilStr);
        if (!Number.isFinite(assetsMil)) continue;

        out.push({ name, assets: assetsMil / 1000 });
      }
      return out.length ? out.sort((a,b)=>b.assets-a.assets) : bankFallback;
    }

    /* ==== Aave TVL history ==== */
    function coercePointUSD(x){
      if (typeof x === 'number') return x;
      if (x && typeof x === 'object'){
        const cand = [x.totalLiquidityUSD, x.totalLiquidityUsd, x.totalLiquidity, x.value, x.tvl, x.usd];
        for (const v of cand) if (typeof v === 'number' && isFinite(v)) return v;
      }
      return null;
    }
    function extractPointDate(x, fallbackDate){
      if (x && typeof x === 'object'){
        if (typeof x.date === 'number') return new Date(x.date * 1000);
        if (typeof x.timestamp === 'number') return new Date(x.timestamp * 1000);
        if (typeof x.ts === 'number') return new Date(x.ts * 1000);
        if (typeof x.time === 'number') return new Date(x.time * 1000);
        if (typeof x.date === 'string'){ const d = new Date(x.date); if (!isNaN(+d)) return d; }
      }
      return fallbackDate ?? null;
    }
    function latestFromHistoryUSD(arr, getter){
      for (let i=(arr?.length||0)-1; i>=0; i--){
        const v = getter(arr[i]);
        if (typeof v === 'number' && v>1e7 && v<1e14) return v;
      }
      return null;
    }
    async function fetchAaveProtocol(slug='aave'){
      return fetchJSON(`https://api.llama.fi/protocol/${slug}`);
    }
    async function fetchAaveHistory(){
      // basic: just get TVL history; borrowed is fixed constant in this version
      const p = await fetchAaveProtocol('aave');
      return Array.isArray(p.tvl) ? p.tvl : [];
    }

    /* ==== Rank series (TVL +/- Borrowed), from CHART_START ==== */
    // returns [{ t:Date, tvlB:Number, effB:Number, rank:Number }]
    function computeRankSeries(banks, aaveHist, includeBorrowed){
      const bankAssetsB = [...banks].map(b => b.assets).sort((a,b)=>b-a);

      // tvl points with dates
      let pts = [];
      for (const p of (aaveHist||[])){
        const usd = coercePointUSD(p);
        if (typeof usd !== 'number') continue;
        const d = extractPointDate(p, null);
        pts.push({ date: d, tvlB: billions(usd) });
      }
      if (!pts.length) return [];

      // normalize, sort, filter start date, collapse per-day
      pts = pts.filter(pt => pt.date instanceof Date && !isNaN(+pt.date))
               .sort((a,b)=>a.date - b.date)
               .filter(pt => pt.date >= CHART_START);
      const byDay = new Map();
      for (const pt of pts){
        const key = pt.date.toISOString().slice(0,10);
        byDay.set(key, pt);
      }
      const dedup = Array.from(byDay.values()).sort((a,b)=>a.date - b.date);

      return dedup.map(pt => {
        const effB = pt.tvlB + (includeBorrowed ? FIXED_BORROWED_B : 0);
        let lo=0, hi=bankAssetsB.length;
        while (lo < hi){
          const mid=(lo+hi)>>1;
          if (bankAssetsB[mid] > effB) lo = mid + 1; else hi = mid;
        }
        return { t: pt.date, tvlB: pt.tvlB, effB, rank: lo + 1 };
      });
    }

    /* ==== Chart drawing + hover ==== */
    let _chartState = { series: [], scales: null, includeBorrowed: false };

    function drawRankChart(canvas, series){
      if (!canvas || !series?.length) return;

      const DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      const cssW = canvas.clientWidth || 600;
      const cssH = canvas.clientHeight || 260;
      const W = Math.max(320, Math.floor(cssW * DPR));
      const H = Math.max(180, Math.floor(cssH * DPR));
      canvas.width = W; canvas.height = H;

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,W,H);

      const PAD_L = 50, PAD_R = 14, PAD_T = 14, PAD_B = 30;
      const plotW = W - PAD_L - PAD_R;
      const plotH = H - PAD_T - PAD_B;

      let minR = Infinity, maxR = -Infinity;
      for (const s of series){ if (s.rank < minR) minR = s.rank; if (s.rank > maxR) maxR = s.rank; }
      if (minR === maxR){ minR = Math.max(1, minR-1); maxR = maxR+1; }

      const t0 = series[0].t.getTime();
      const t1 = series[series.length-1].t.getTime();
      const dt = Math.max(1, t1 - t0);

      const x = (t) => PAD_L + ((t - t0) / dt) * plotW;
      const y = (r) => PAD_T + ((r - minR) / (maxR - minR)) * plotH;

      const grid = getComputedStyle(document.documentElement).getPropertyValue('--grid');
      const line = getComputedStyle(document.documentElement).getPropertyValue('--line');

      // grid
      const yMin = y(minR), yMax = y(maxR), yMid = y((minR+maxR)/2);
      ctx.strokeStyle = grid; ctx.lineWidth = Math.max(1, DPR);
      ctx.beginPath(); ctx.moveTo(PAD_L, yMin); ctx.lineTo(W-PAD_R, yMin); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(PAD_L, yMid); ctx.lineTo(W-PAD_R, yMid); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(PAD_L, yMax); ctx.lineTo(W-PAD_R, yMax); ctx.stroke();

      // labels
      ctx.fillStyle = 'rgba(255,255,255,.95)';
      ctx.font = `${12*DPR}px Arial`;
      ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
      ctx.fillText(`#${Math.round(minR)}`, PAD_L - 8, yMin);
      ctx.fillText(`#${Math.round(maxR)}`, PAD_L - 8, yMax);

      ctx.textAlign = 'left'; ctx.textBaseline = 'top';
      const fmt = (d)=>d.toLocaleDateString(undefined,{year:'2-digit',month:'short',day:'2-digit'});
      ctx.fillText(fmt(series[0].t), PAD_L, H - PAD_B + 4*DPR);
      ctx.textAlign = 'right';
      ctx.fillText(fmt(series[series.length-1].t), W - PAD_R, H - PAD_B + 4*DPR);

      // glow
      ctx.strokeStyle = 'rgba(255,255,255,.35)';
      ctx.lineWidth = Math.max(6, 6*DPR);
      ctx.globalAlpha = .35;
      ctx.beginPath();
      for (let i=0;i<series.length;i++){
        const px = x(series[i].t.getTime()), py = y(series[i].rank);
        if (i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
      }
      ctx.stroke();
      ctx.globalAlpha = 1;

      // main line
      ctx.strokeStyle = line;
      ctx.lineWidth = Math.max(2, 2*DPR);
      ctx.lineJoin = 'round'; ctx.lineCap = 'round';
      ctx.beginPath();
      for (let i=0;i<series.length;i++){
        const px = x(series[i].t.getTime()), py = y(series[i].rank);
        if (i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
      }
      ctx.stroke();

      _chartState.series = series;
      _chartState.scales = {PAD_L, PAD_R, PAD_T, PAD_B, W, H, plotW, plotH, t0, t1, minR, maxR, DPR, x, y};
    }

    function setupHover(canvas, wrapEl, tooltip){
      function showTooltip(ix){
        const { series, scales } = _chartState;
        if (!series?.length || !scales) return;

        ix = Math.max(0, Math.min(series.length-1, ix));
        const p = series[ix];
        const px = scales.x(p.t.getTime());
        const py = scales.y(p.rank);

        const tvlUSD = p.tvlB * 1e9;
        const tvlFmt = `$${tvlUSD.toLocaleString(undefined,{maximumFractionDigits:0})}`;
        const borrowedFmt = `$${(FIXED_BORROWED_B*1e9).toLocaleString(undefined,{maximumFractionDigits:0})}`;

        tooltip.innerHTML = `
          <div><strong>${p.t.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'})}</strong></div>
          <div class="muted">TVL</div><div>${tvlFmt}</div>
          <div class="muted">Borrowed</div><div>${borrowedFmt}</div>
          <div class="muted">Rank</div><div>#${p.rank}</div>
        `;
        tooltip.style.left = `${px / scales.DPR}px`;
        tooltip.style.top  = `${py / scales.DPR}px`;
        tooltip.style.display = 'block';

        // highlight
        drawRankChart(canvas, series);
        const ctx = canvas.getContext('2d');
        ctx.save();
        ctx.strokeStyle = 'rgba(255,255,255,.55)';
        ctx.lineWidth = Math.max(1, 1*scales.DPR);
        ctx.setLineDash([4*scales.DPR, 4*scales.DPR]);
        ctx.beginPath(); ctx.moveTo(px, scales.PAD_T); ctx.lineTo(px, scales.H - scales.PAD_B); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(px, py, 3.5*scales.DPR, 0, Math.PI*2); ctx.fill();
        ctx.restore();
      }

      function nearestIndexAt(clientX){
        const { series, scales } = _chartState;
        if (!series?.length || !scales) return 0;
        const rect = canvas.getBoundingClientRect();
        const cx = (clientX - rect.left) * (canvas.width / rect.width);
        const tMouse = scales.t0 + ((cx - scales.PAD_L) / Math.max(1, scales.plotW)) * (scales.t1 - scales.t0);

        let lo=0, hi=series.length-1;
        while (lo<hi){
          const mid=(lo+hi)>>1;
          if (series[mid].t.getTime() < tMouse) lo=mid+1; else hi=mid;
        }
        let idx = lo;
        if (idx>0){
          const d1 = Math.abs(series[idx].t - tMouse);
          const d0 = Math.abs(series[idx-1].t - tMouse);
          if (d0 < d1) idx = idx-1;
        }
        return idx;
      }

      function hideTooltip(){
        tooltip.style.display = 'none';
        if (_chartState.series?.length) drawRankChart(canvas, _chartState.series);
      }

      wrapEl.addEventListener('mousemove', (ev)=> showTooltip(nearestIndexAt(ev.clientX)));
      wrapEl.addEventListener('mouseleave', hideTooltip);
      wrapEl.addEventListener('touchstart', (ev)=>{ if (ev.touches?.length) showTooltip(nearestIndexAt(ev.touches[0].clientX)); }, {passive:true});
      wrapEl.addEventListener('touchmove',  (ev)=>{ if (ev.touches?.length) showTooltip(nearestIndexAt(ev.touches[0].clientX)); }, {passive:true});
      wrapEl.addEventListener('touchend', hideTooltip);
    }

    /* ==== Rank delta (today vs previous day) ==== */
    function computeRankDeltaUp(series){
      if (!Array.isArray(series) || series.length < 2) return 3; // fallback
      const prev = series[series.length - 2].rank;
      const curr = series[series.length - 1].rank;
      const delta = prev - curr; // positive means moved UP
      return delta > 0 ? delta : 0;
    }

    /* ==== Today table ==== */
    function renderToday(banks, tvlUSD_or_null, includeBorrowed, rankDeltaUp = 3){
      const tbody = $('#tableBody');
      tbody.innerHTML = '';

      const tvlB = ((tvlUSD_or_null ?? (AAVE_FALLBACK_B*1e9)) / 1e9);
      const aaveEffB = tvlB + (includeBorrowed ? FIXED_BORROWED_B : 0);

      const combined = [...banks, { name:'Aave', assets: aaveEffB, isAave:true }];
      const sorted = combined.sort((a,b)=>b.assets-a.assets);
      const idx = sorted.findIndex(x=>x.isAave);

      const start = Math.max(0, idx - 4);
      const end   = Math.min(sorted.length - 1, idx + 5);
      const windowed = sorted.slice(start, end+1);

      for (let i=0;i<windowed.length;i++){
        const item = windowed[i];
        const rank = start + i + 1;
        const isAave = !!item.isAave;

        const tr = document.createElement('tr');
        if (isAave) tr.className = 'aave-row highlight';

        const nameCell = isAave
          ? `<div class="aave-wrap">
               <span class="logo"><img src="aave.svg" alt="Aave logo" style="width:150px;height:72px;vertical-align:middle;"></span>
               <a class="deposit" href="https://app.aave.com/" target="_blank" rel="noopener noreferrer">ðŸ’§ Deposit now</a>
             </div>`
          : item.name;

        const badge = isAave
          ? `<span class="rank-badge" aria-label="moved up ${rankDeltaUp} places since previous day">
               <span class="arrow">â†‘</span> ${rankDeltaUp}
             </span>`
          : '';

        tr.innerHTML = `
          <td data-label="Rank">${rank}${badge}</td>
          <td data-label="Name">${nameCell}</td>
          <td data-label="Assets"><span class="assets">${formatB(item.assets)}</span></td>
        `;
        tbody.appendChild(tr);
      }

      const mode = includeBorrowed ? 'TVL + Borrowed' : 'TVL only';
      const msg = $('#msg');
      msg.style.display = 'block';
      msg.textContent = `Showing Aave (mode: ${mode}) with ${banks.length} banks â€¢ Today only`;
    }

    /* ==== KPIs ==== */
    function updateKpis(banks, tvlUSD, includeBorrowed){
      const tvlB = (tvlUSD ?? (AAVE_FALLBACK_B*1e9)) / 1e9;
      const aaveEffB = tvlB + (includeBorrowed ? FIXED_BORROWED_B : 0);

      // rank
      const bankAssetsB = [...banks].map(b => b.assets).sort((a,b)=>b-a);
      let lo=0, hi=bankAssetsB.length;
      while (lo < hi){
        const mid=(lo+hi)>>1;
        if (bankAssetsB[mid] > aaveEffB) lo = mid + 1; else hi = mid;
      }
      const rank = lo + 1;
      $('#kpiRank').textContent = `#${rank}`;

      // borrowed KPI is fixed
      $('#kpiBorrowed').textContent = `$${FIXED_BORROWED_B.toFixed(2)}B`;
      $('#kpiRow').style.display = 'grid';
    }

    /* ==== App state & boot ==== */
    const App = {
      banks: [],
      tvlHist: [],
      includeBorrowed: false
    };

    async function boot(){
      let banksCache = readCache(BANKS_KEY);
      if (!banksCache){
        try { banksCache = { updatedAt: nowISO(), banks: await fetchBanksFull() }; }
        catch { banksCache = { updatedAt: nowISO(), banks: bankFallback }; }
        writeCache(BANKS_KEY, banksCache);
      }
      setBadge('#banksBadge', banksCache.updatedAt, 'No banks cache yet');
      App.banks = banksCache.banks || bankFallback;

      let aaveCache = readCache(AAVE_KEY);
      if (!aaveCache){
        try { aaveCache = { updatedAt: nowISO(), history: await fetchAaveHistory() }; }
        catch { aaveCache = { updatedAt: nowISO(), history: [] }; }
        writeCache(AAVE_KEY, aaveCache);
      }
      setBadge('#aaveBadge', aaveCache.updatedAt, 'No aave cache yet');
      App.tvlHist = aaveCache.history || [];

      // Chart & series
      const aUSD = latestFromHistoryUSD(App.tvlHist, coercePointUSD) ?? null;
      renderEverything(aUSD);

      $('#loading').style.display = 'none';
      $('#dataTable').style.display = 'table';
      const ts = banksCache.updatedAt || aaveCache.updatedAt || nowISO();
      $('#lastUpdated').textContent = `Last updated: ${new Date(ts).toLocaleString()}`;

      // interactions
      setupHover($('#rankChart'), $('#chartWrap'), $('#tooltip'));
      window.addEventListener('resize', () => {
        if (_chartState.series?.length) drawRankChart($('#rankChart'), _chartState.series);
      });

      // toggle events (click + keyboard)
      const sw = $('#borrowedSwitch');
      const setSwitch = (on)=>{ sw.classList.toggle('on', on); sw.setAttribute('aria-checked', on ? 'true' : 'false'); };
      const toggle = ()=> { App.includeBorrowed = !App.includeBorrowed; setSwitch(App.includeBorrowed); renderEverything(latestFromHistoryUSD(App.tvlHist, coercePointUSD)); };
      sw.addEventListener('click', toggle);
      sw.addEventListener('keydown', (e)=>{ if (e.key===' '||e.key==='Enter'){ e.preventDefault(); toggle(); }});
      setSwitch(App.includeBorrowed);
    }

    function renderEverything(latestTVLUSD){
      const series = computeRankSeries(App.banks, App.tvlHist, App.includeBorrowed);
      if (series.length){
        $('#rankCard').style.display = 'block';
        drawRankChart($('#rankChart'), series);
      } else {
        $('#rankCard').style.display = 'none';
      }
      const rankDeltaUp = computeRankDeltaUp(series);
      updateKpis(App.banks, latestTVLUSD, App.includeBorrowed);
      renderToday(App.banks, latestTVLUSD, App.includeBorrowed, rankDeltaUp);
    }

    /* ==== Buttons ==== */
    $('#refreshBanks').addEventListener('click', async (e)=>{
      const btn = e.currentTarget; btn.disabled = true; btn.textContent = 'Refreshingâ€¦';
      try{
        const banks = await fetchBanksFull();
        const stamp = nowISO();
        writeCache(BANKS_KEY, { updatedAt: stamp, banks });
        setBadge('#banksBadge', stamp, 'No banks cache yet');

        App.banks = banks;
        renderEverything(latestFromHistoryUSD(App.tvlHist, coercePointUSD));
        $('#lastUpdated').textContent = `Last updated: ${new Date(stamp).toLocaleString()} (banks)`;
      }catch(err){
        console.error(err);
        alert('Refreshing bank data failed. Using cached/fallback.');
      }finally{
        btn.disabled = false; btn.textContent = 'ðŸ”„ Refresh Bank Data';
      }
    });

    $('#refreshAave').addEventListener('click', async (e)=>{
      const btn = e.currentTarget; btn.disabled = true; btn.textContent = 'Refreshingâ€¦';
      try{
        const tvl = await fetchAaveHistory();
        const stamp = nowISO();
        writeCache(AAVE_KEY, { updatedAt: stamp, history: tvl });
        setBadge('#aaveBadge', stamp, 'No aave cache yet');

        App.tvlHist = tvl;
        renderEverything(latestFromHistoryUSD(App.tvlHist, coercePointUSD));
        $('#lastUpdated').textContent = `Last updated: ${new Date(stamp).toLocaleString()} (aave)`;
      }catch(err){
        console.error(err);
        alert('Refreshing Aave data failed. Using cached/fallback.');
      }finally{
        btn.disabled = false; btn.textContent = 'ðŸ”„ Refresh Aave Data';
      }
    });

    $('#exportBanks').addEventListener('click', ()=>{
      const cache = readCache(BANKS_KEY);
      if (!cache){ alert('No banks cache yet. Refresh first.'); return; }
      downloadJSON(cache, 'banks.json');
    });
    $('#exportAave').addEventListener('click', ()=>{
      const cache = readCache(AAVE_KEY);
      if (!cache){ alert('No aave cache yet. Refresh first.'); return; }
      downloadJSON(cache, 'aave.json');
    });

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
