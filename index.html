<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aave vs Banks</title>
  <style>
    :root{
      --bg:#9C8CF4;
      --card:rgba(255,255,255,.06);
      --card-2:rgba(255,255,255,.08);
      --highlight:rgba(255,255,255,.22);
      --text:#ffffff;
      --up:#31d158;
      --down:#ff6b6b;
      --badge: rgba(0,0,0,.35);
      --badge-border: rgba(255,255,255,.25);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .container{
      max-width:1000px;
      margin:0 auto;
      padding:48px 20px 24px;
    }
    header h1{
      font-size: clamp(32px, 5vw, 64px);
      margin:0 0 10px;
    }
    header p{
      margin:0 0 28px;
      opacity:.95;
      font-size: clamp(14px, 1.6vw, 18px);
    }

    .controls{
      display:flex; gap:12px; align-items:center; justify-content:flex-end; margin-bottom:12px;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none; border:1px solid var(--badge-border); background:var(--badge);
      color:var(--text); padding:10px 14px; border-radius:999px; cursor:pointer;
      font-weight:700; letter-spacing:.02em;
    }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; background:var(--badge);
      border:1px solid var(--badge-border); font-size:12px;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:#9fdc9f; }
    .dot.stale{ background:#ffd27d; }
    .dot.error{ background:#ff9b9b; }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      background: var(--card);
      border-radius:18px;
      overflow:hidden;
    }
    th, td{
      padding:18px 20px;
      text-align:left;
      vertical-align:middle;
    }
    th{
      font-size:14px;
      letter-spacing:.06em;
      text-transform:uppercase;
      opacity:.85;
      border-bottom:1px solid rgba(255,255,255,.16);
    }
    tr:nth-child(even){ background: var(--card-2); }

    .highlight{
      position:relative;
      background: var(--highlight) !important;
      font-weight:700;
    }
    .highlight::before{
      content:"";
      position:absolute; inset:0 auto 0 0;
      width:6px;
      background: linear-gradient(180deg, #fff, rgba(255,255,255,.5));
    }
    /* Remove the left accent only for the Aave row */
    .aave-row.highlight::before{ display:none; }

    .rank-change{
      font-weight:800; font-size:14px;
      padding:4px 8px; border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      margin-left:8px;
    }
    .up{ color: var(--up); }
    .down{ color: var(--down); }

    .loading {
      text-align: center;
      padding: 40px;
      opacity: 0.7;
    }
    .error {
      color: #ff6b6b;
      text-align: center;
      padding: 20px;
      font-size: 14px;
    }
    .last-updated {
      text-align: center;
      margin-top: 14px;
      font-size: 12px;
      opacity: 0.8;
    }
    .tagline{
      margin-top:20px;
      font-weight:700;
      letter-spacing:.02em;
      text-align: center;
    }

    @media (max-width: 720px){
      thead{ display:none; }
      table, tbody, tr, td{ display:block; width:100%; }
      tr{ padding:12px 14px; }
      td{
        padding:8px 6px 8px 120px;
        position:relative;
        border-bottom:1px dashed rgba(255,255,255,.18);
      }
      td::before{
        content: attr(data-label);
        position:absolute; left:14px; top:8px;
        font-weight:700; opacity:.9;
      }
      .highlight::before{ width:4px; }
      .controls{ justify-content:space-between; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Aave vs Banks</h1>
      <p>Built in a rush with love by Hoobi</p>
    </header>

    <div class="controls">
      <span id="statusBadge" class="badge" aria-live="polite"><span class="dot stale"></span><span>Loading…</span></span>
      <button id="refreshBtn" class="btn" type="button" aria-label="Refresh data">Refresh</button>
    </div>

    <div class="table-container">
      <div id="loading" class="loading" role="status" aria-live="polite">Loading banking data…</div>
      <table id="dataTable" style="display:none;" aria-label="Aave vs Banks ranking">
        <thead>
          <tr>
            <th scope="col">Rank</th>
            <th scope="col">Name</th>
            <th scope="col">Assets</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="info" class="error" style="display:none;"></div>
    </div>

    <div id="lastUpdated" class="last-updated" aria-live="polite"></div>
    <p class="tagline">DeFi will win, Ethereum will win!</p>
  </div>

  <script>
    // ---------------- Config & Cache Keys ----------------
    const CACHE_KEY = 'avb:payload:v3';   // bump to invalidate any old/bad caches
    const CACHE_AT  = 'avb:updatedAt:v3';

    // ---------------- Fallback dataset (your original list) ----------------
    const bankData = [
      { name: "JPMORGAN CHASE BK NA", assets: 3643.099 },
      { name: "BANK OF AMER NA", assets: 2615.296 },
      { name: "CITIBANK NA", assets: 1760.921 },
      { name: "WELLS FARGO BK NA", assets: 1711.028 },
      { name: "U S BK NA", assets: 659.191 },
      { name: "GOLDMAN SACHS BK USA", assets: 598.460 },
      { name: "PNC BK NA", assets: 549.324 },
      { name: "TRUIST BK", assets: 527.488 },
      { name: "CAPITAL ONE NA", assets: 490.573 },
      { name: "STATE STREET B&TC", assets: 368.219 },
      { name: "TD BK NA", assets: 366.507 },
      { name: "BANK OF NY MELLON", assets: 356.262 },
      { name: "BMO BK NA", assets: 257.049 },
      { name: "MORGAN STANLEY BK NA", assets: 234.481 },
      { name: "FIRST-CITIZENS B&TC", assets: 228.632 },
      { name: "CITIZENS BK NA", assets: 220.014 },
      { name: "FIFTH THIRD BK NA", assets: 211.921 },
      { name: "MANUFACTURERS & TRADERS TC", assets: 209.801 },
      { name: "HUNTINGTON NB", assets: 208.159 },
      { name: "AMERICAN EXPRESS NB", assets: 203.448 },
      { name: "KEYBANK NA", assets: 185.776 },
      { name: "ALLY BK", assets: 182.323 },
      { name: "HSBC BK USA NA", assets: 166.237 },
      { name: "NORTHERN TC", assets: 164.498 },
      { name: "REGIONS BK", assets: 158.421 },
      { name: "DISCOVER BK", assets: 145.413 },
      { name: "SANTANDER BK NA", assets: 104.559 },
      { name: "FLAGSTAR BK NA", assets: 97.568 },
      { name: "CITY NB", assets: 93.149 },
      { name: "ZIONS BC NA", assets: 87.992 },
      { name: "WESTERN ALLI BK", assets: 82.944 },
      { name: "FIRST HORIZON BK", assets: 81.202 },
      { name: "WEBSTER BK NA", assets: 80.212 },
      { name: "COMERICA BK", assets: 77.698 },
      { name: "EAST WEST BK", assets: 75.712 },
      { name: "UMB BK NA", assets: 69.014 },
      { name: "SOUTHSTATE BK NA", assets: 65.109 },
      { name: "VALLEY NB", assets: 61.818 },
      { name: "CIBC BK USA", assets: 61.303 },
      { name: "SYNOVUS BK", assets: 60.208 },
      { name: "PINNACLE BK", assets: 54.173 },
      { name: "OLD NB", assets: 53.574 },
      { name: "FROST BK", assets: 52.059 },
      { name: "UMPQUA BK", assets: 51.509 },
      { name: "BOKF NA", assets: 50.345 },
      { name: "FIRST NB OF PA", assets: 48.800 },
      { name: "CADENCE BK", assets: 47.743 },
      { name: "BARCLAYS BK DE", assets: 45.277 },
      { name: "ASSOCIATED BK NA", assets: 43.249 },
      { name: "RAYMOND JAMES BK", assets: 41.907 },
      { name: "EVERBANK NA", assets: 41.858 },
      { name: "DEUTSCHE BK TC AMERICAS", assets: 39.663 },
      { name: "BANK OZK", assets: 39.165 },
      { name: "PROSPERITY BK", assets: 38.764 },
      { name: "BANKUNITED NA", assets: 34.811 },
      { name: "HANCOCK WHITNEY BK", assets: 34.732 },
      { name: "BANC OF CA", assets: 33.692 },
      { name: "SOFI BK NA", assets: 32.857 },
      { name: "UNITED BK", assets: 32.691 },
      { name: "COMMERCE BK", assets: 32.239 },
      { name: "FULTON BK NA", assets: 31.989 },
      { name: "FIRST NB OF OMAHA", assets: 31.792 },
      { name: "TEXAS CAP BK", assets: 31.103 },
      { name: "BNY MELLON NA", assets: 30.061 },
      { name: "FIRST INTRST BK", assets: 28.204 },
      { name: "GLACIER BK", assets: 27.842 },
      { name: "UNITED CMNTY BK", assets: 27.827 },
      { name: "WASHINGTON FED BK", assets: 27.629 },
      { name: "WESBANCO BK", assets: 27.321 },
      { name: "CITY NB OF FL", assets: 27.175 },
      { name: "ARVEST BK", assets: 27.136 },
      { name: "FIRSTBANK", assets: 27.110 },
      { name: "SIMMONS BK", assets: 26.749 },
      { name: "AMERIS BK", assets: 26.428 }
    ];

    // ---------------- Utilities ----------------
    function formatAssets(amount) {
      return `$${amount.toFixed(1)} B`;
    }
    function generateRankChange() {
      const up = Math.random() > 0.5;
      const places = Math.floor(Math.random() * 4) + 1; // purely decorative
      return { direction: up ? 'up' : 'down', places, symbol: up ? '▲' : '▼' };
    }
    function setBadge(state, text){
      const badge = document.getElementById('statusBadge');
      const dot = badge.querySelector('.dot');
      const label = badge.querySelector('span:last-child');
      dot.className = 'dot' + (state==='fresh' ? '' : state==='stale' ? ' stale' : ' error');
      label.textContent = text;
    }
    function setLastUpdated(dateMs, source){
      const el = document.getElementById('lastUpdated');
      const dt = new Date(dateMs);
      el.textContent = `${source === 'cache' ? 'Showing cached data' : source==='fallback' ? 'Showing fallback data' : 'Showing fresh data'} — Last updated: ${dt.toLocaleString()}`;
    }

    // ---------------- Cache helpers (with validation) ----------------
    function isValidPayload(p){
      if (!p || !Array.isArray(p.banks)) return false;
      const enoughRows = p.banks.length >= 40;
      const tvlOk = typeof p.aaveTVL === 'number' && p.aaveTVL > 1 && p.aaveTVL < 2000;
      const rowsOK = p.banks.every(b => b && typeof b.name === 'string' && typeof b.assets === 'number');
      return enoughRows && tvlOk && rowsOK;
    }
    function saveCache(payload){
      try{
        if (!isValidPayload(payload)) return;
        localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
        localStorage.setItem(CACHE_AT, String(Date.now()));
      }catch(e){ /* ignore */ }
    }
    function readCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        const at  = localStorage.getItem(CACHE_AT);
        if(!raw || !at) return null;
        const payload = JSON.parse(raw);
        const updatedAt = Number(at);
        if(!isValidPayload(payload)) return null;
        return { payload, updatedAt };
      }catch(e){ return null; }
    }

    // ---------------- Network helpers ----------------
    async function fetchWithTimeout(url, options = {}, timeoutMs = 15000){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try{
        return await fetch(url, { ...options, signal: controller.signal });
      } finally {
        clearTimeout(id);
      }
    }

    // ---------------- Data Fetchers ----------------
    async function fetchAaveTVL() {
      try {
        const res = await fetchWithTimeout('https://api.llama.fi/protocol/aave', { cache: 'no-store' }, 15000);
        if (!res.ok) throw new Error('Aave TVL fetch failed');
        const data = await res.json();
        if (data?.tvl?.length) {
          const latest = data.tvl[data.tvl.length - 1];
          const tvl = latest.totalLiquidityUSD ?? latest.totalLiquidityUsd ?? latest.totalLiquidity;
          if (typeof tvl === 'number') return tvl / 1_000_000_000; // → billions
        }
      } catch (e) {
        console.error('Error fetching Aave TVL:', e);
      }
      return null;
    }

    async function fetchBankData() {
      try {
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const targetUrl = encodeURIComponent('https://www.federalreserve.gov/releases/lbr/current/');
        const res = await fetchWithTimeout(proxyUrl + targetUrl, { cache: 'no-store' }, 15000);
        if (!res.ok) throw new Error('Bank data fetch failed');

        const proxyData = await res.json();
        const htmlContent = proxyData.contents;
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');

        const rows = doc.querySelectorAll('tr');
        const extractedBanks = [];

        for (let row of rows) {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 6) {
            const bankName = cells[0]?.textContent?.trim() || '';
            const assets = cells[5]?.textContent?.trim() || '';
            if ((bankName.includes('BK') || bankName.includes('BANK')) && assets) {
              const assetsNum = parseFloat(assets.replace(/[^0-9.]/g, ''));
              if (!isNaN(assetsNum) && assetsNum > 100) {
                extractedBanks.push({
                  name: bankName.split('/')[0].trim(),
                  assets: assetsNum / 1000 // millions → billions
                });
              }
            }
          }
        }
        const banks = extractedBanks.sort((a,b)=>b.assets-a.assets).slice(0, 50);
        if (banks.length >= 40) return { banks, ok: true };
        return { banks: bankData, ok: false }; // not enough parsed → fallback
      } catch (e) {
        console.error('Error fetching bank data:', e);
        return { banks: bankData, ok: false }; // network failure → fallback
      }
    }

    // ---------------- Rendering ----------------
    function renderTable(allBanks, aaveTVL) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';

      const combinedData = [...allBanks];
      combinedData.push({ name: "Aave", assets: aaveTVL ?? 12.5, isAave: true });

      const sortedData = combinedData.sort((a, b) => b.assets - a.assets);
      const aaveIndex = sortedData.findIndex(item => item.isAave);

      const startIndex = Math.max(0, aaveIndex - 4);
      const endIndex = Math.min(sortedData.length - 1, aaveIndex + 5);
      const displayData = sortedData.slice(startIndex, endIndex + 1);

      displayData.forEach((item, index) => {
        const actualRank = startIndex + index + 1;
        const change = generateRankChange();
        const isAave = !!item.isAave;

        const row = document.createElement('tr');
        if (isAave) row.className = 'aave-row highlight';

        const nameCellContent = isAave ? `<strong>Aave</strong>` : item.name;

        row.innerHTML = `
          <td data-label="Rank">${actualRank}
            <span class="rank-change ${change.direction}" aria-label="rank change ${change.direction} by ${change.places}">
              ${change.symbol} ${change.places}
            </span>
          </td>
          <td data-label="Name">${nameCellContent}</td>
          <td data-label="Assets">${formatAssets(item.assets)}</td>
        `;
        tableBody.appendChild(row);
      });

      const aaveRank = aaveIndex + 1;
      const info = document.getElementById('info');
      info.textContent = `Showing Aave (rank ${aaveRank}) with 4 banks above and 5 banks below. Total institutions: ${sortedData.length}`;
      info.style.display = 'block';
      info.style.color = '#ffffff';
      info.style.opacity = '0.8';
    }

    // ---------------- Orchestration (SWR) ----------------
    async function refreshData({silent=false} = {}){
      const refreshBtn = document.getElementById('refreshBtn');
      try{
        refreshBtn.disabled = true;
        if(!silent) setBadge('stale','Refreshing…');

        const [{banks, ok}, aaveTVLraw] = await Promise.all([fetchBankData(), fetchAaveTVL()]);
        const aaveTVL = (typeof aaveTVLraw === 'number' ? aaveTVLraw : 12.5);
        const allBanks = banks && banks.length ? banks : bankData;

        renderTable(allBanks, aaveTVL);
        setBadge(ok ? 'fresh' : 'stale', ok ? 'Fresh' : 'Fallback');
        setLastUpdated(Date.now(), ok ? 'live' : 'fallback');

        // Save to cache only if live data was good
        if (ok) saveCache({ banks: allBanks, aaveTVL });

        document.getElementById('loading').style.display = 'none';
        document.getElementById('dataTable').style.display = 'table';
      }catch(e){
        console.error(e);
        setBadge('error','Refresh failed');
      }finally{
        refreshBtn.disabled = false;
      }
    }

    function boot(){
      // 1) Try cache → instant render (even if stale)
      const cached = readCache();
      if (cached?.payload){
        const { banks, aaveTVL } = cached.payload;
        renderTable(banks, aaveTVL);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dataTable').style.display = 'table';
        setBadge('stale','Cached');
        setLastUpdated(cached.updatedAt, 'cache');
        refreshData({silent:true}); // revalidate in background
      } else {
        // 2) No cache → render fallback immediately, then refresh
        renderTable(bankData, 12.5);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dataTable').style.display = 'table';
        setBadge('stale','Fallback');
        setLastUpdated(Date.now(), 'fallback');
        refreshData({silent:true});
      }

      // 3) Controls
      document.getElementById('refreshBtn').addEventListener('click', () => refreshData());
      setInterval(() => refreshData({silent:true}), 5 * 60 * 1000);

      // 4) Inline Service Worker for instant revisits/offline (optional, safe)
      if ('serviceWorker' in navigator) {
        const swCode = `
          const STATIC_CACHE = 'avb-static-v1';
          self.addEventListener('install', (e) => {
            e.waitUntil(
              caches.open(STATIC_CACHE).then(c => c.addAll([
                self.registration.scope, // the HTML itself
              ]))
            );
            self.skipWaiting();
          });
          self.addEventListener('activate', (e)=>e.waitUntil(self.clients.claim()));
          self.addEventListener('fetch', (event) => {
            const { request } = event;
            // Cache-first for document; network for APIs
            if (request.mode === 'navigate') {
              event.respondWith(
                caches.match(request).then(cached => cached || fetch(request).then(resp => {
                  const copy = resp.clone();
                  caches.open(STATIC_CACHE).then(c => c.put(request, copy));
                  return resp;
                }).catch(()=>cached))
              );
            }
          });
        `;
        const blob = new Blob([swCode], { type: 'text/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).catch(console.error);
      }
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
