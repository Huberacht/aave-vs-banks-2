<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aave vs Banks</title>
  <style>
    :root{
      --bg:#9C8CF4;
      --card:rgba(255,255,255,.06);
      --card-2:rgba(255,255,255,.08);
      --highlight:rgba(255,255,255,.22);
      --text:#ffffff;
      --up:#31d158;
      --down:#ff6b6b;
      --ink:#0b061d;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family: Arial, sans-serif; background: var(--bg); color: var(--text); }
    .container{ max-width:1000px; margin:0 auto; padding:48px 20px 24px; }
    header h1{ font-size: clamp(32px, 5vw, 64px); margin:0 0 10px; }
    header p{ margin:0 0 18px; opacity:.95; font-size: clamp(14px, 1.6vw, 18px); }

    /* Action bar */
    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 28px; }
    .btn{ background:#fff; color:var(--ink); border:none; border-radius:999px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.15); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .pill{ padding:8px 12px; border-radius:999px; background: rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.28); font-size:12px; }
    .muted{ opacity:.8; }

    table{ width:100%; border-collapse:separate; border-spacing:0; background: var(--card); border-radius:18px; overflow:hidden; }
    th, td{ padding:18px 20px; text-align:left; vertical-align:middle; }
    th{ font-size:14px; letter-spacing:.06em; text-transform:uppercase; opacity:.85; border-bottom:1px solid rgba(255,255,255,.16); }
    tr:nth-child(even){ background: var(--card-2); }

    .highlight{ position:relative; background: var(--highlight) !important; font-weight:700; }
    .highlight::before{ content:""; position:absolute; inset:0 auto 0 0; width:6px; background: linear-gradient(180deg, #fff, rgba(255,255,255,.5)); }
    .aave-row.highlight::before{ display:none; }

    .rank-change{ font-weight:800; font-size:14px; padding:4px 8px; border-radius:999px; background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.22); margin-left:8px; }
    .down{ color: var(--down); }

    .aave-row .logo { display:inline-block; width:72px; height:72px; margin-right:0; vertical-align:middle; }

    .loading { text-align: center; padding: 40px; opacity: 0.7; }
    .error { color: #ff6b6b; text-align: center; padding: 20px; font-size: 14px; }
    .last-updated { text-align: center; margin-top: 20px; font-size: 12px; opacity: 0.7; }
    .tagline{ margin-top:20px; font-weight:700; letter-spacing:.02em; text-align: center; }

    @media (max-width: 720px){
      thead{ display:none; }
      table, tbody, tr, td{ display:block; width:100%; }
      tr{ padding:12px 14px; }
      td{ padding:8px 6px 8px 120px; position:relative; border-bottom:1px dashed rgba(255,255,255,.18); }
      td::before{ content: attr(data-label); position:absolute; left:14px; top:8px; font-weight:700; opacity:.9; }
      .highlight::before{ width:4px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Aave vs Banks</h1>
      <p>Built in a rush with love by Hoobi</p>

      <div class="actions">
        <button id="refreshBtn" class="btn" aria-label="Refresh data">ðŸ”„ Refresh</button>
        <button id="exportBtn" class="btn" aria-label="Export cached data">ðŸ’¾ Export</button>
        <label for="importInput" class="btn" role="button" aria-label="Import cached data">ðŸ“¥ Import</label>
        <input id="importInput" type="file" accept="application/json" style="display:none" />
        <span id="cacheBadge" class="pill muted" aria-live="polite">No cache yet</span>
      </div>
    </header>

    <div class="table-container">
      <div id="loading" class="loading" role="status" aria-live="polite">Loading dataâ€¦</div>
      <table id="dataTable" style="display:none;" aria-label="Aave vs Banks ranking">
        <thead>
          <tr>
            <th scope="col">Rank</th>
            <th scope="col">Name</th>
            <th scope="col">Assets</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="error" class="error" style="display:none;"></div>
    </div>

    <div id="lastUpdated" class="last-updated" aria-live="polite"></div>
    <p class="tagline">DeFi will win, Ethereum will win!</p>
  </div>

  <script>
    // --------- Cache ---------
    const CACHE_KEY = 'aaveBanksCacheV1';
    const CACHE_MAX_AGE_MS = 24 * 60 * 60 * 1000; // 24h
    const AAVE_FALLBACK_BILLIONS = 12.5;

    function readCache() {
      try { return JSON.parse(localStorage.getItem(CACHE_KEY) || 'null'); } catch { return null; }
    }
    function writeCache(payload) {
      localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
      updateCacheBadge(payload.updatedAt, true);
    }
    function updateCacheBadge(updatedAt, hasCache) {
      const el = document.getElementById('cacheBadge');
      if (!hasCache) { el.textContent = 'No cache yet'; return; }
      const d = new Date(updatedAt);
      el.textContent = `Cached: ${d.toLocaleString()}`;
    }

    // ---------- BANKS: fallback dataset ----------
    const bankData = [
      { name: "JPMORGAN CHASE BK NA", assets: 3643.099 },
      { name: "BANK OF AMER NA", assets: 2615.296 },
      { name: "CITIBANK NA", assets: 1760.921 },
      { name: "WELLS FARGO BK NA", assets: 1711.028 },
      { name: "U S BK NA", assets: 659.191 },
      { name: "GOLDMAN SACHS BK USA", assets: 598.460 },
      { name: "PNC BK NA", assets: 549.324 },
      { name: "TRUIST BK", assets: 527.488 },
      { name: "CAPITAL ONE NA", assets: 490.573 },
      { name: "STATE STREET B&TC", assets: 368.219 },
      { name: "TD BK NA", assets: 366.507 },
      { name: "BANK OF NY MELLON", assets: 356.262 },
      { name: "BMO BK NA", assets: 257.049 },
      { name: "MORGAN STANLEY BK NA", assets: 234.481 },
      { name: "FIRST-CITIZENS B&TC", assets: 228.632 },
      { name: "CITIZENS BK NA", assets: 220.014 },
      { name: "FIFTH THIRD BK NA", assets: 211.921 },
      { name: "MANUFACTURERS & TRADERS TC", assets: 209.801 },
      { name: "HUNTINGTON NB", assets: 208.159 },
      { name: "AMERICAN EXPRESS NB", assets: 203.448 },
      { name: "KEYBANK NA", assets: 185.776 },
      { name: "ALLY BK", assets: 182.323 },
      { name: "HSBC BK USA NA", assets: 166.237 },
      { name: "NORTHERN TC", assets: 164.498 },
      { name: "REGIONS BK", assets: 158.421 },
      { name: "DISCOVER BK", assets: 145.413 },
      { name: "SANTANDER BK NA", assets: 104.559 },
      { name: "FLAGSTAR BK NA", assets: 97.568 },
      { name: "CITY NB", assets: 93.149 },
      { name: "ZIONS BC NA", assets: 87.992 },
      { name: "WESTERN ALLI BK", assets: 82.944 },
      { name: "FIRST HORIZON BK", assets: 81.202 },
      { name: "WEBSTER BK NA", assets: 80.212 },
      { name: "COMERICA BK", assets: 77.698 },
      { name: "EAST WEST BK", assets: 75.712 },
      { name: "UMB BK NA", assets: 69.014 },
      { name: "SOUTHSTATE BK NA", assets: 65.109 },
      { name: "VALLEY NB", assets: 61.818 },
      { name: "CIBC BK USA", assets: 61.303 },
      { name: "SYNOVUS BK", assets: 60.208 },
      { name: "PINNACLE BK", assets: 54.173 },
      { name: "OLD NB", assets: 53.574 },
      { name: "FROST BK", assets: 52.059 },
      { name: "UMPQUA BK", assets: 51.509 },
      { name: "BOKF NA", assets: 50.345 },
      { name: "FIRST NB OF PA", assets: 48.800 },
      { name: "CADENCE BK", assets: 47.743 },
      { name: "BARCLAYS BK DE", assets: 45.277 },
      { name: "ASSOCIATED BK NA", assets: 43.249 },
      { name: "RAYMOND JAMES BK", assets: 41.907 },
      { name: "EVERBANK NA", assets: 41.858 },
      { name: "DEUTSCHE BK TC AMERICAS", assets: 39.663 },
      { name: "BANK OZK", assets: 39.165 },
      { name: "PROSPERITY BK", assets: 38.764 },
      { name: "BANKUNITED NA", assets: 34.811 },
      { name: "HANCOCK WHITNEY BK", assets: 34.732 },
      { name: "BANC OF CA", assets: 33.692 },
      { name: "SOFI BK NA", assets: 32.857 },
      { name: "UNITED BK", assets: 32.691 },
      { name: "COMMERCE BK", assets: 32.239 },
      { name: "FULTON BK NA", assets: 31.989 },
      { name: "FIRST NB OF OMAHA", assets: 31.792 },
      { name: "TEXAS CAP BK", assets: 31.103 },
      { name: "BNY MELLON NA", assets: 30.061 },
      { name: "FIRST INTRST BK", assets: 28.204 },
      { name: "GLACIER BK", assets: 27.842 },
      { name: "UNITED CMNTY BK", assets: 27.827 },
      { name: "WASHINGTON FED BK", assets: 27.629 },
      { name: "WESBANCO BK", assets: 27.321 },
      { name: "CITY NB OF FL", assets: 27.175 },
      { name: "ARVEST BK", assets: 27.136 },
      { name: "FIRSTBANK", assets: 27.110 },
      { name: "SIMMONS BK", assets: 26.749 },
      { name: "AMERIS BK", assets: 26.428 }
    ];

    function formatAssets(amount) { return `$${amount.toFixed(1)} B`; }

    // ---------- DeFiLlama: /protocols (only) ----------
    async function fetchJSON(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return res.json();
    }

    async function fetchAaveTVL_Billions() {
      // Docs endpoint: returns list of protocols with current tvl (USD)
      // https://api.llama.fi/protocols
      try {
        const list = await fetchJSON('https://api.llama.fi/protocols');
        if (!Array.isArray(list)) throw new Error('Unexpected payload');

        // 1) Prefer canonical "aave" slug
        const aave = list.find(p => p && p.slug === 'aave');
        if (aave && typeof aave.tvl === 'number' && isFinite(aave.tvl)) {
          return aave.tvl / 1e9;
        }

        // 2) Otherwise, sum v2 + v3 (many UIs show these separately)
        const v2 = list.find(p => p && p.slug === 'aave-v2');
        const v3 = list.find(p => p && p.slug === 'aave-v3');
        let sum = 0;
        if (v2 && typeof v2.tvl === 'number') sum += v2.tvl;
        if (v3 && typeof v3.tvl === 'number') sum += v3.tvl;
        if (sum > 0) return sum / 1e9;

        // 3) As a last resort, fuzzy by name (rarely needed)
        const fuzzy = list.find(p => p?.name && /^aave(\s|$)/i.test(p.name) && typeof p.tvl === 'number');
        if (fuzzy) return fuzzy.tvl / 1e9;
      } catch (e) {
        console.error('DefiLlama /protocols failed:', e);
      }
      return null; // let caller fallback
    }

    // ---------- Fed scrape via proxy ----------
    async function fetchBankData() {
      try {
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const targetUrl = encodeURIComponent('https://www.federalreserve.gov/releases/lbr/current/');
        const response = await fetch(proxyUrl + targetUrl, { cache: 'no-store' });
        if (!response.ok) throw new Error('Failed to fetch bank data');

        const proxyData = await response.json();
        const htmlContent = proxyData.contents;
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');

        const rows = doc.querySelectorAll('tr');
        const extractedBanks = [];
        for (let row of rows) {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 6) {
            const bankName = cells[0]?.textContent?.trim() || '';
            const assets = cells[5]?.textContent?.trim() || '';
            if ((bankName.includes('BK') || bankName.includes('BANK')) && assets) {
              const assetsNum = parseFloat(assets.replace(/[^0-9.]/g, ''));
              if (!isNaN(assetsNum) && assetsNum > 100) {
                extractedBanks.push({ name: bankName.split('/')[0].trim(), assets: assetsNum / 1000 });
              }
            }
          }
        }
        return extractedBanks.sort((a,b)=>b.assets-a.assets).slice(0, 50);
      } catch (error) {
        console.error('Error fetching bank data:', error);
        return bankData;
      }
    }

    // ---------- Rendering ----------
    function renderTable(allBanks, aaveTVL) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';

      const combinedData = [...allBanks];
      combinedData.push({ name: "Aave", assets: aaveTVL ?? AAVE_FALLBACK_BILLIONS, isAave: true });

      const sortedData = combinedData.sort((a, b) => b.assets - a.assets);
      const aaveIndex = sortedData.findIndex(item => item.isAave);

      const startIndex = Math.max(0, aaveIndex - 4);
      const endIndex = Math.min(sortedData.length - 1, aaveIndex + 5);
      const displayData = sortedData.slice(startIndex, endIndex + 1);

      displayData.forEach((item, index) => {
        const actualRank = startIndex + index + 1;
        const isAave = !!item.isAave;

        const row = document.createElement('tr');
        if (isAave) row.className = 'aave-row highlight';

        const nameCellContent = isAave
          ? `
            <span class="logo" aria-hidden="true">
              <img src="aave.svg" alt="Aave logo" style="width:150px; height:72px; vertical-align:middle;">
            </span>
          `
          : item.name;

        // ONLY Aave shows a rank-change badge, always a down arrow.
        const rankBadge = isAave
          ? `<span class="rank-change down" aria-label="rank change down">â–¼</span>`
          : '';

        row.innerHTML = `
          <td data-label="Rank">${actualRank}${rankBadge}</td>
          <td data-label="Name">${nameCellContent}</td>
          <td data-label="Assets">${formatAssets(item.assets)}</td>
        `;
        tableBody.appendChild(row);
      });

      const aaveRank = aaveIndex + 1;
      const msg = `Showing Aave (rank ${aaveRank}) with 4 banks above and 5 banks below. Total institutions: ${sortedData.length}`;
      const info = document.getElementById('error');
      info.textContent = msg;
      info.style.display = 'block';
      info.style.color = '#ffffff';
      info.style.opacity = '0.8';
    }

    // ---------- Snapshot / Export / Import ----------
    function makeSnapshot(banks, aaveTVL) {
      return { version: 2, updatedAt: new Date().toISOString(), banks, aaveTVL: aaveTVL ?? AAVE_FALLBACK_BILLIONS };
    }
    function downloadJSON(obj, filename) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // ---------- Init / Refresh ----------
    async function refreshFromNetwork() {
      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.disabled = true; refreshBtn.textContent = 'Refreshingâ€¦';
      try {
        const [banks, aaveTVL] = await Promise.all([fetchBankData(), fetchAaveTVL_Billions()]);
        const allBanks = banks.length > 20 ? banks : bankData;

        renderTable(allBanks, aaveTVL ?? AAVE_FALLBACK_BILLIONS);

        const snap = makeSnapshot(allBanks, aaveTVL ?? AAVE_FALLBACK_BILLIONS);
        writeCache(snap);
        document.getElementById('lastUpdated').textContent = `Last updated: ${new Date(snap.updatedAt).toLocaleString()}`;
      } catch (e) {
        console.error('Refresh failed:', e);
      } finally {
        refreshBtn.disabled = false; refreshBtn.textContent = 'ðŸ”„ Refresh';
      }
    }

    async function boot() {
      const cached = readCache();
      if (cached) {
        renderTable(cached.banks, cached.aaveTVL);
        updateCacheBadge(cached.updatedAt, true);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dataTable').style.display = 'table';
        document.getElementById('lastUpdated').textContent = `Last updated: ${new Date(cached.updatedAt).toLocaleString()} (cached)`;
      } else {
        updateCacheBadge(null, false);
        await refreshFromNetwork();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dataTable').style.display = 'table';
      }
    }

    // ---------- Buttons ----------
    document.getElementById('refreshBtn').addEventListener('click', refreshFromNetwork);
    document.getElementById('exportBtn').addEventListener('click', () => {
      const cached = readCache();
      if (!cached) { alert('No cache yet. Click Refresh first.'); return; }
      downloadJSON(cached, 'aave-banks-data.json');
    });
    document.getElementById('importInput').addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const obj = JSON.parse(text);
        if (!obj || !obj.banks || typeof obj.aaveTVL !== 'number') throw new Error('Invalid file');
        writeCache(obj);
        renderTable(obj.banks, obj.aaveTVL);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dataTable').style.display = 'table';
        document.getElementById('lastUpdated').textContent = `Last updated: ${new Date(obj.updatedAt || Date.now()).toLocaleString()} (imported)`;
      } catch (e) {
        alert('Could not import: ' + e.message);
      } finally {
        ev.target.value = '';
      }
    });

    // ---------- Start ----------
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
