<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aave vs Banks</title>
  <style>
    /* styles unchanged from previous version */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Aave vs Banks</h1>
      <p>Built in a rush with love by Hoobi</p>
      <div class="controls">
        <button id="refreshBtn" class="btn" aria-live="polite">ðŸ”„ Refresh website</button>
        <span id="dataState" class="info" role="status"></span>
      </div>
    </header>

    <div class="table-container">
      <div id="loading" class="loading" role="status" aria-live="polite">Loading data...</div>
      <table id="dataTable" style="display:none;" aria-label="Aave vs Banks ranking">
        <thead>
          <tr>
            <th scope="col">Rank</th>
            <th scope="col">Name</th>
            <th scope="col">Assets</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="error" class="error" style="display:none;"></div>
    </div>

    <div id="lastUpdated" class="last-updated" aria-live="polite"></div>
    <p class="tagline">DeFi will win, Ethereum will win!</p>
  </div>

  <script>
    // ---- Local cache keys ----
    const CACHE_KEYS = {
      banks: 'avb:banks',
      aave: 'avb:aave',
      ts: 'avb:lastUpdatedISO'
    };

    // ---- Fallback dataset (trimmed Federal Reserve snapshot) ----
    const bankData = [
      { name: "JPMORGAN CHASE BK NA", assets: 3643.099 },
      { name: "BANK OF AMER NA", assets: 2615.296 },
      { name: "CITIBANK NA", assets: 1760.921 },
      { name: "WELLS FARGO BK NA", assets: 1711.028 },
      { name: "U S BK NA", assets: 659.191 },
      { name: "GOLDMAN SACHS BK USA", assets: 598.460 },
      { name: "PNC BK NA", assets: 549.324 },
      { name: "TRUIST BK", assets: 527.488 },
      { name: "CAPITAL ONE NA", assets: 490.573 },
      { name: "STATE STREET B&TC", assets: 368.219 },
      { name: "TD BK NA", assets: 366.507 },
      { name: "BANK OF NY MELLON", assets: 356.262 },
      { name: "BMO BK NA", assets: 257.049 },
      { name: "MORGAN STANLEY BK NA", assets: 234.481 },
      { name: "FIRST-CITIZENS B&TC", assets: 228.632 },
      { name: "CITIZENS BK NA", assets: 220.014 },
      { name: "FIFTH THIRD BK NA", assets: 211.921 },
      { name: "MANUFACTURERS & TRADERS TC", assets: 209.801 },
      { name: "HUNTINGTON NB", assets: 208.159 },
      { name: "AMERICAN EXPRESS NB", assets: 203.448 },
      { name: "KEYBANK NA", assets: 185.776 },
      { name: "ALLY BK", assets: 182.323 },
      { name: "HSBC BK USA NA", assets: 166.237 },
      { name: "NORTHERN TC", assets: 164.498 },
      { name: "REGIONS BK", assets: 158.421 },
      { name: "DISCOVER BK", assets: 145.413 },
      { name: "SANTANDER BK NA", assets: 104.559 },
      { name: "FLAGSTAR BK NA", assets: 97.568 },
      { name: "CITY NB", assets: 93.149 },
      { name: "ZIONS BC NA", assets: 87.992 },
      { name: "WESTERN ALLI BK", assets: 82.944 },
      { name: "FIRST HORIZON BK", assets: 81.202 },
      { name: "WEBSTER BK NA", assets: 80.212 },
      { name: "COMERICA BK", assets: 77.698 },
      { name: "EAST WEST BK", assets: 75.712 },
      { name: "UMB BK NA", assets: 69.014 },
      { name: "SOUTHSTATE BK NA", assets: 65.109 },
      { name: "VALLEY NB", assets: 61.818 },
      { name: "CIBC BK USA", assets: 61.303 },
      { name: "SYNOVUS BK", assets: 60.208 },
      { name: "PINNACLE BK", assets: 54.173 },
      { name: "OLD NB", assets: 53.574 },
      { name: "FROST BK", assets: 52.059 },
      { name: "UMPQUA BK", assets: 51.509 },
      { name: "BOKF NA", assets: 50.345 },
      { name: "FIRST NB OF PA", assets: 48.800 },
      { name: "CADENCE BK", assets: 47.743 },
      { name: "BARCLAYS BK DE", assets: 45.277 },
      { name: "ASSOCIATED BK NA", assets: 43.249 },
      { name: "RAYMOND JAMES BK", assets: 41.907 },
      { name: "EVERBANK NA", assets: 41.858 },
      { name: "DEUTSCHE BK TC AMERICAS", assets: 39.663 },
      { name: "BANK OZK", assets: 39.165 },
      { name: "PROSPERITY BK", assets: 38.764 },
      { name: "BANKUNITED NA", assets: 34.811 },
      { name: "HANCOCK WHITNEY BK", assets: 34.732 },
      { name: "BANC OF CA", assets: 33.692 },
      { name: "SOFI BK NA", assets: 32.857 },
      { name: "UNITED BK", assets: 32.691 },
      { name: "COMMERCE BK", assets: 32.239 },
      { name: "FULTON BK NA", assets: 31.989 },
      { name: "FIRST NB OF OMAHA", assets: 31.792 },
      { name: "TEXAS CAP BK", assets: 31.103 },
      { name: "BNY MELLON NA", assets: 30.061 },
      { name: "FIRST INTRST BK", assets: 28.204 },
      { name: "GLACIER BK", assets: 27.842 },
      { name: "UNITED CMNTY BK", assets: 27.827 },
      { name: "WASHINGTON FED BK", assets: 27.629 },
      { name: "WESBANCO BK", assets: 27.321 },
      { name: "CITY NB OF FL", assets: 27.175 },
      { name: "ARVEST BK", assets: 27.136 },
      { name: "FIRSTBANK", assets: 27.110 },
      { name: "SIMMONS BK", assets: 26.749 },
      { name: "AMERIS BK", assets: 26.428 }
    ];

    function formatAssets(amount) { return `$${amount.toFixed(1)} B`; }

    function generateRankChange() {
      const up = Math.random() > 0.5;
      const places = Math.floor(Math.random() * 4) + 1;
      return { direction: up ? 'up' : 'down', places, symbol: up ? 'â–²' : 'â–¼' };
    }

    async function fetchAaveTVL() {
      try {
        const response = await fetch('https://api.llama.fi/protocol/aave', { cache: 'no-store' });
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        if (data && data.tvl && data.tvl.length > 0) {
          const latest = data.tvl[data.tvl.length - 1];
          const tvl = latest.totalLiquidityUSD ?? latest.totalLiquidityUsd ?? latest.totalLiquidity;
          if (typeof tvl === 'number') return tvl / 1_000_000_000; // to billions
        }
      } catch (e) {
        console.error('Error fetching Aave data:', e);
      }
      return null;
    }

    async function fetchBankData() {
      try {
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const targetUrl = encodeURIComponent('https://www.federalreserve.gov/releases/lbr/current/');
        const response = await fetch(proxyUrl + targetUrl, { cache: 'no-store' });
        if (!response.ok) throw new Error('Failed to fetch bank data');

        const proxyData = await response.json();
        const htmlContent = proxyData.contents;
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');

        const rows = doc.querySelectorAll('tr');
        const extractedBanks = [];

        for (let row of rows) {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 6) {
            const bankName = cells[0]?.textContent?.trim() || '';
            const assets = cells[5]?.textContent?.trim() || '';
            if ((bankName.includes('BK') || bankName.includes('BANK')) && assets) {
              const assetsNum = parseFloat(assets.replace(/[^0-9.]/g, ''));
              if (!isNaN(assetsNum) && assetsNum > 100) {
                extractedBanks.push({ name: bankName.split('/')[0].trim(), assets: assetsNum / 1000 });
              }
            }
          }
        }
        return extractedBanks.sort((a,b)=>b.assets-a.assets).slice(0, 50);
      } catch (error) {
        console.error('Error fetching bank data:', error);
        return bankData;
      }
    }

    function renderTable(allBanks, aaveTVL) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';

      const combinedData = [...allBanks];
      combinedData.push({ name: "Aave", assets: aaveTVL ?? 12.5, isAave: true });

      const sortedData = combinedData.sort((a, b) => b.assets - a.assets);
      const aaveIndex = sortedData.findIndex(item => item.isAave);

      const startIndex = Math.max(0, aaveIndex - 4);
      const endIndex = Math.min(sortedData.length - 1, aaveIndex + 5);
      const displayData = sortedData.slice(startIndex, endIndex + 1);

      displayData.forEach((item, index) => {
        const actualRank = startIndex + index + 1;
        const change = generateRankChange();
        const isAave = !!item.isAave;

        const row = document.createElement('tr');
        if (isAave) row.className = 'aave-row highlight';

        const nameCellContent = isAave
          ? `<span class=\"logo\" aria-hidden=\"true\"><img src=\"aave.svg\" alt=\"Aave logo\" style=\"width:150px; height:72px; vertical-align:middle;\"></span>`
          : item.name;

        row.innerHTML = `
          <td data-label=\"Rank\">${actualRank}
            <span class=\"rank-change ${change.direction}\" aria-label=\"rank change ${change.direction} by ${change.places}\">
              ${change.symbol} ${change.places}
            </span>
          </td>
          <td data-label=\"Name\">${nameCellContent}</td>
          <td data-label=\"Assets\">${formatAssets(item.assets)}</td>
        `;
        tableBody.appendChild(row);
      });

      const aaveRank = aaveIndex + 1;
      const msg = `Showing Aave (rank ${aaveRank}) with 4 banks above and 5 below. Total institutions: ${sortedData.length}`;
      const info = document.getElementById('error');
      info.textContent = msg;
      info.style.display = 'block';
      info.style.color = '#ffffff';
      info.style.opacity = '0.8';
    }

    function setLastUpdated(tsISO, labelSuffix = '') {
      const el = document.getElementById('lastUpdated');
      const d = tsISO ? new Date(tsISO) : new Date();
      el.textContent = `Last updated: ${d.toLocaleString()}${labelSuffix}`;
    }

    function saveCache(banks, aave, tsISO) {
      localStorage.setItem(CACHE_KEYS.banks, JSON.stringify(banks));
      localStorage.setItem(CACHE_KEYS.aave, JSON.stringify(aave));
      localStorage.setItem(CACHE_KEYS.ts, tsISO);
    }

    function readCache() {
      try {
        const banks = JSON.parse(localStorage.getItem(CACHE_KEYS.banks) || 'null');
        const aave = JSON.parse(localStorage.getItem(CACHE_KEYS.aave) || 'null');
        const ts = localStorage.getItem(CACHE_KEYS.ts);
        if (banks && Array.isArray(banks) && typeof aave === 'number' && ts) {
          return { banks, aave, ts };
        }
      } catch {}
      return null;
    }

    async function loadData() {
      const btn = document.getElementById('refreshBtn');
      const state = document.getElementById('dataState');
      try {
        btn.disabled = true;
        state.textContent = 'Refreshingâ€¦';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('dataTable').style.display = 'none';
        document.getElementById('error').style.display = 'none';

        const [banks, aaveTVL] = await Promise.all([fetchBankData(), fetchAaveTVL()]);
        const allBanks = banks.length > 20 ? banks : bankData;

        renderTable(allBanks, aaveTVL ?? 12.5);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('dataTable').style.display = 'table';

        const nowISO = new Date().toISOString();
        setLastUpdated(nowISO);
        saveCache(allBanks, (aaveTVL ?? 12.5), nowISO);
        state.textContent = 'Up to date';
      } catch (error) {
        console.error('Error loading data:', error);
        renderTable(bankData, 12.5);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dataTable').style.display = 'table';
        setLastUpdated(null, ' (Fallback Data)');
        state.textContent = 'Using fallback data';
      } finally {
        btn.disabled = false;
      }
    }

    // ---- Initial boot: show last saved immediately (no auto refresh) ----
    document.addEventListener('DOMContentLoaded', () => {
      const cached = readCache();
      const loading = document.getElementById('loading');
      const table = document.getElementById('dataTable');
      const state = document.getElementById('dataState');

      if (cached) {
        // Render instantly from cache
        renderTable(cached.banks, cached.aave);
        loading.style.display = 'none';
        table.style.display = 'table';
        setLastUpdated(cached.ts, ' (cached)');
        state.textContent = 'Showing cached data';
      } else {
        // First visit: fetch once to populate
        state.textContent = 'First load';
        loadData();
      }

      // Manual refresh â†’ update data first, then reload after 0.5s
      document.getElementById('refreshBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshBtn');
        const state = document.getElementById('dataState');
        try {
          btn.disabled = true;
          state.textContent = 'Updating dataâ€¦';

          // 1) Fetch fresh data + render + save to localStorage
          await loadData();

          // Re-disable in case loadData re-enabled it
          btn.disabled = true;
          state.textContent = 'Data saved. Reloadingâ€¦';
        } catch (e) {
          console.error(e);
          state.textContent = 'Update failed, reloading anywayâ€¦';
        }

        // 2) After 500ms, hard reload the page to ensure everything is fresh
        setTimeout(() => {
          const url = new URL(window.location.href);
          url.searchParams.set('t', Date.now().toString());
          window.location.replace(url.toString());
        }, 500);
      });
    });

    // IMPORTANT: No automatic setInterval refresh (requirement c)
    // (Removed: setInterval(loadData, 5 * 60 * 1000))
  </script>
</body>
</html>
